# 驗屋預約系統規則需求文件

## 文件資訊
- **版本**: 1.0
- **建立日期**: 2026-01-27
- **適用範圍**: 驗屋預約功能模組
- **相關頁面**: 
  - `reservation-inspection.html` (驗屋預約列表)
  - `reservation-inspection-schedule.html` (時段管理)
  - `reservation-inspection-edit.html` (預約編輯)

---

## 一、功能概述

驗屋預約系統採用「**雙層卡控機制**」，確保預約流程合理且可控。

### 預約流程架構
```
第一層卡控：戶別可預約時段範圍
    ↓ (符合條件的戶別)
第二層卡控：每時段組數上限
    ↓ (時段尚有餘額)
預約成功
```

---

## 二、第一層卡控：戶別驗屋時段管理

### 2.1 功能說明
管理員需為每個戶別設定「可預約的日期範圍」，只有在此範圍內的戶別才能進行預約。

### 2.2 設定內容
| 欄位 | 說明 | 必填 |
|------|------|------|
| 建案 | 所屬建案名稱 (例如：陸府原森) | ✓ |
| 戶別 | 戶別編號 (例如：A1-1F) | ✓ |
| 開始日期 | 該戶別最早可預約日期 | ✓ |
| 結束日期 | 該戶別最晚可預約日期 | ✓ |
| 已預約日期 | 實際預約日期 (系統自動記錄) | - |
| 預約單號 | 預約單編號 (系統自動產生) | - |
| 完成驗屋日期 | 實際驗屋完成日期 (系統記錄) | - |

### 2.3 操作功能
1. **批次設定**
   - 可同時為多個戶別設定相同的開放時段
   - 支援勾選多個戶別進行批次操作
   - 減少重複設定作業

2. **單一編輯**
   - 針對個別戶別調整開放時段
   - 彈窗顯示戶別資訊
   - 修改開始/結束日期

3. **篩選查詢**
   - 依建案篩選
   - 依日期範圍篩選
   - 依戶別關鍵字搜尋

### 2.4 驗證規則
```javascript
// 第一層檢查：戶別是否已設定開放時段
function checkUnitSchedule(unitId, reservationDate) {
    const unitSchedule = getUnitSchedule(unitId);
    
    // 規則 1: 戶別必須已設定時段
    if (!unitSchedule || !unitSchedule.startDate || !unitSchedule.endDate) {
        return {
            valid: false,
            message: "該戶別尚未開放預約，請聯繫管理人員設定"
        };
    }
    
    // 規則 2: 預約日期必須在開放範圍內
    if (reservationDate < unitSchedule.startDate || 
        reservationDate > unitSchedule.endDate) {
        return {
            valid: false,
            message: `該戶別可預約時段為 ${unitSchedule.startDate} ~ ${unitSchedule.endDate}`
        };
    }
    
    // 規則 3: 該戶別不可重複預約
    if (unitSchedule.reservedDate) {
        return {
            valid: false,
            message: `該戶別已於 ${unitSchedule.reservedDate} 完成預約`
        };
    }
    
    return { valid: true };
}
```

---

## 三、第二層卡控：時段組數上限管理

### 3.1 功能說明
在戶別通過第一層檢查後，系統需進一步檢查該時段是否還有可預約名額。

### 3.2 時段設定規格
| 項目 | 說明 |
|------|------|
| 建案 | 每個建案獨立設定 |
| 時間粒度 | 每 1 小時為一個時段 |
| 營業時間 | 09:00 - 18:00 (共 10 個時段) |
| 組數設定 | 0 組 (不開放) / 1 組 / 2 組 / 3 組 |
| 設定方式 | 點擊格子循環切換 0→1→2→3→0 |

### 3.3 時段表格結構
```
     | 星期日 | 星期一 | 星期二 | 星期三 | 星期四 | 星期五 | 星期六 |
-----|--------|--------|--------|--------|--------|--------|--------|
09:00|   2    |   3    |   3    |   0    |   2    |   3    |   1    |
10:00|   2    |   3    |   3    |   0    |   2    |   3    |   1    |
11:00|   1    |   2    |   2    |   0    |   2    |   2    |   0    |
...
18:00|   1    |   1    |   1    |   0    |   1    |   1    |   0    |
```

### 3.4 視覺化標示
| 組數 | 背景顏色 | CSS Class | 說明 |
|------|----------|-----------|------|
| 0 組 | 灰色 | `slot-available` | 不可預約 |
| 1 組 | 淺綠色 | `slot-booked-1` | 可預約 1 組 |
| 2 組 | 綠色 | `slot-booked-2` | 可預約 2 組 |
| 3 組 | 深綠色 | `slot-booked-3` | 可預約 3 組 |

### 3.5 操作功能
1. **快速複製**
   - 複製上一週設定至當週
   - 適用於固定排班模式

2. **週別切換**
   - 前一週 / 後一週導覽
   - 顯示日期範圍

3. **即時儲存**
   - 點擊「確認儲存」批次更新
   - 顯示成功訊息提示

### 3.6 驗證規則
```javascript
// 第二層檢查：時段是否還有名額
function checkTimeSlotAvailability(projectName, date, timeSlot) {
    const slotConfig = getTimeSlotConfig(projectName, date, timeSlot);
    
    // 規則 1: 該時段必須有開放名額
    if (slotConfig.maxCapacity === 0) {
        return {
            valid: false,
            message: "該時段未開放預約"
        };
    }
    
    // 規則 2: 檢查目前已預約數量
    const currentBookings = getBookingCount(projectName, date, timeSlot);
    
    if (currentBookings >= slotConfig.maxCapacity) {
        return {
            valid: false,
            message: `該時段已額滿 (${currentBookings}/${slotConfig.maxCapacity})`
        };
    }
    
    return { 
        valid: true,
        remaining: slotConfig.maxCapacity - currentBookings
    };
}
```

---

## 四、預約流程整合邏輯

### 4.1 完整驗證流程
```javascript
/**
 * 用戶發起預約時的完整檢查流程
 * @param {string} unitId - 戶別 ID
 * @param {string} projectName - 建案名稱
 * @param {string} date - 預約日期 (YYYY-MM-DD)
 * @param {string} timeSlot - 預約時段 (HH:00)
 * @returns {object} 驗證結果
 */
function validateReservation(unitId, projectName, date, timeSlot) {
    // 第一層檢查：戶別驗屋時段
    const unitCheck = checkUnitSchedule(unitId, date);
    if (!unitCheck.valid) {
        return unitCheck;
    }
    
    // 第二層檢查：時段組數上限
    const slotCheck = checkTimeSlotAvailability(projectName, date, timeSlot);
    if (!slotCheck.valid) {
        return slotCheck;
    }
    
    // 全部通過
    return {
        valid: true,
        message: `可預約！剩餘 ${slotCheck.remaining} 組名額`,
        remaining: slotCheck.remaining
    };
}
```

### 4.2 預約建立流程
```
1. 用戶選擇【案場】→ 自動載入該案場的戶別清單
   ↓
2. 用戶選擇【戶別】→ 檢查該戶別是否已設定開放時段
   ↓ (若未設定，顯示錯誤訊息並中斷)
3. 用戶選擇【日期】→ 檢查日期是否在戶別開放範圍內
   ↓ (若超出範圍，顯示可預約日期範圍)
4. 用戶選擇【時段】→ 檢查該時段是否還有名額
   ↓ (若已額滿，顯示其他可選時段)
5. 提交預約 → 建立預約單，扣除時段名額
   ↓
6. 更新戶別狀態：記錄「已預約日期」、「預約單號」
```

---

## 五、資料表結構建議

### 5.1 戶別時段表 (unit_inspection_schedule)
| 欄位名稱 | 資料類型 | 說明 | 索引 |
|---------|---------|------|------|
| id | INT | 主鍵 | PK |
| project_name | VARCHAR(50) | 建案名稱 | INDEX |
| unit_id | VARCHAR(20) | 戶別編號 | UNIQUE |
| start_date | DATE | 開始日期 | - |
| end_date | DATE | 結束日期 | - |
| reserved_date | DATE | 已預約日期 | - |
| reservation_no | VARCHAR(20) | 預約單號 | INDEX |
| completed_date | DATE | 完成日期 | - |
| created_at | DATETIME | 建立時間 | - |
| updated_at | DATETIME | 更新時間 | - |

### 5.2 時段設定表 (inspection_time_slots)
| 欄位名稱 | 資料類型 | 說明 | 索引 |
|---------|---------|------|------|
| id | INT | 主鍵 | PK |
| project_name | VARCHAR(50) | 建案名稱 | INDEX |
| date | DATE | 日期 | INDEX |
| time_slot | TIME | 時段 (例如：09:00) | INDEX |
| max_capacity | TINYINT | 最大組數 (0-3) | - |
| current_bookings | TINYINT | 目前預約數 | - |
| created_at | DATETIME | 建立時間 | - |
| updated_at | DATETIME | 更新時間 | - |

**複合索引**: `(project_name, date, time_slot)` - 用於快速查詢特定時段

### 5.3 預約單表 (inspection_reservations)
| 欄位名稱 | 資料類型 | 說明 | 索引 |
|---------|---------|------|------|
| id | INT | 主鍵 | PK |
| reservation_no | VARCHAR(20) | 預約單號 | UNIQUE |
| project_name | VARCHAR(50) | 建案名稱 | INDEX |
| unit_id | VARCHAR(20) | 戶別編號 | INDEX |
| member_name | VARCHAR(50) | 會員姓名 | - |
| member_phone | VARCHAR(15) | 會員手機 | - |
| reservation_date | DATE | 預約日期 | INDEX |
| reservation_time | TIME | 預約時段 | - |
| status | VARCHAR(20) | 狀態 (reserved/completed/cancelled) | INDEX |
| created_at | DATETIME | 建立時間 | - |
| updated_at | DATETIME | 更新時間 | - |

---

## 六、錯誤訊息對照表

| 錯誤代碼 | 訊息內容 | 觸發條件 |
|---------|---------|---------|
| ERR_UNIT_001 | 該戶別尚未開放預約，請聯繫管理人員設定 | 戶別未設定開放時段 |
| ERR_UNIT_002 | 該戶別可預約時段為 {start_date} ~ {end_date} | 預約日期超出戶別開放範圍 |
| ERR_UNIT_003 | 該戶別已於 {reserved_date} 完成預約 | 戶別已有預約記錄 |
| ERR_SLOT_001 | 該時段未開放預約 | 時段設定為 0 組 |
| ERR_SLOT_002 | 該時段已額滿 ({current}/{max}) | 已達時段上限 |
| ERR_DATE_001 | 預約日期不可早於今日 | 選擇過去日期 |
| ERR_DATE_002 | 預約日期不可晚於 {max_date} | 超過系統允許最大日期 |

---

## 七、前端介面提示建議

### 7.1 戶別選擇下拉選單
```html
<!-- 示範：根據戶別狀態顯示不同提示 -->
<option value="A1-1F" data-status="available">A1-1F (可預約)</option>
<option value="A1-2F" data-status="not-set" disabled>A1-2F (未開放)</option>
<option value="A1-3F" data-status="reserved" disabled>A1-3F (已預約)</option>
```

### 7.2 時段選擇即時顯示
```
驗屋時段選擇：
☐ 09:00-10:00 (剩餘 2 組)
☐ 10:00-11:00 (剩餘 1 組)
☒ 11:00-12:00 (已額滿)
☐ 13:00-14:00 (剩餘 3 組)
```

### 7.3 成功預約後提示
```
✓ 預約成功！
預約單號：ins25081501
建案：陸府原森
戶別：A1-1F
日期時間：2025-08-15 09:00-10:00
聯絡人：王小明 (0912-345-678)
```

---

## 八、API 接口建議

### 8.1 檢查戶別可預約狀態
```
GET /api/unit-schedule/check
參數:
  - unitId: 戶別 ID
  - date: 預約日期
回應:
  {
    "valid": true/false,
    "startDate": "2025-06-02",
    "endDate": "2025-12-12",
    "message": "可預約" | "錯誤訊息"
  }
```

### 8.2 查詢時段可用名額
```
GET /api/time-slots/availability
參數:
  - projectName: 建案名稱
  - date: 日期
  - timeSlot: 時段 (可選，若不提供則返回當日所有時段)
回應:
  {
    "date": "2025-08-15",
    "slots": [
      {
        "time": "09:00",
        "maxCapacity": 3,
        "currentBookings": 1,
        "remaining": 2,
        "available": true
      },
      {
        "time": "10:00",
        "maxCapacity": 2,
        "currentBookings": 2,
        "remaining": 0,
        "available": false
      }
    ]
  }
```

### 8.3 建立預約
```
POST /api/reservations/create
Body:
  {
    "projectName": "陸府原森",
    "unitId": "A1-1F",
    "memberName": "王小明",
    "memberPhone": "0912345678",
    "reservationDate": "2025-08-15",
    "reservationTime": "09:00"
  }
回應:
  {
    "success": true,
    "reservationNo": "ins25081501",
    "message": "預約成功"
  }
```

---

## 九、權限管理

| 角色 | 戶別時段管理 | 時段組數管理 | 預約建立/編輯 | 預約查詢 |
|------|------------|------------|-------------|---------|
| 系統管理員 | ✓ | ✓ | ✓ | ✓ |
| 案場管理員 | ✓ (限本案場) | ✓ (限本案場) | ✓ | ✓ |
| 客服人員 | ✗ | ✗ | ✓ | ✓ |
| 一般住戶 | ✗ | ✗ | ✓ (限本人) | ✓ (限本人) |

---

## 十、測試案例

### 10.1 戶別時段檢查
| 測試案例 | 戶別狀態 | 預約日期 | 預期結果 |
|---------|---------|---------|---------|
| TC-01 | 未設定開放時段 | 2025-08-15 | ✗ 顯示「尚未開放預約」 |
| TC-02 | 開放時段 2025-06-02~2025-12-12 | 2025-05-01 | ✗ 顯示「超出可預約範圍」 |
| TC-03 | 開放時段 2025-06-02~2025-12-12 | 2025-08-15 | ✓ 通過第一層檢查 |
| TC-04 | 已預約於 2025-08-15 | 2025-08-20 | ✗ 顯示「該戶已預約」 |

### 10.2 時段名額檢查
| 測試案例 | 時段設定 | 已預約數 | 預期結果 |
|---------|---------|---------|---------|
| TC-05 | 0 組 | 0 | ✗ 顯示「時段未開放」 |
| TC-06 | 3 組 | 0 | ✓ 可預約，剩餘 3 組 |
| TC-07 | 3 組 | 2 | ✓ 可預約，剩餘 1 組 |
| TC-08 | 3 組 | 3 | ✗ 顯示「時段已額滿」 |

### 10.3 整合測試
| 測試案例 | 戶別檢查 | 時段檢查 | 預期結果 |
|---------|---------|---------|---------|
| TC-09 | ✓ 通過 | ✓ 通過 | ✓ 預約成功 |
| TC-10 | ✓ 通過 | ✗ 額滿 | ✗ 預約失敗 (時段) |
| TC-11 | ✗ 超出範圍 | ✓ 通過 | ✗ 預約失敗 (戶別) |
| TC-12 | ✗ 已預約 | ✓ 通過 | ✗ 預約失敗 (重複) |

---

## 十一、注意事項與建議

### 11.1 效能優化
1. **快取機制**
   - 時段設定資料可快取 5-10 分鐘
   - 減少資料庫查詢次數

2. **批次查詢**
   - 查詢當日所有時段時使用 IN 查詢
   - 避免多次單筆查詢

3. **索引優化**
   - 務必為 `(project_name, date, time_slot)` 建立複合索引
   - 加速時段查詢效能

### 11.2 並發控制
```javascript
// 使用樂觀鎖或悲觀鎖避免超賣
BEGIN TRANSACTION;

// 查詢並鎖定該時段記錄
SELECT * FROM inspection_time_slots 
WHERE project_name = ? AND date = ? AND time_slot = ?
FOR UPDATE;

// 檢查是否還有名額
IF current_bookings < max_capacity THEN
    // 建立預約
    INSERT INTO inspection_reservations (...) VALUES (...);
    
    // 更新時段預約數
    UPDATE inspection_time_slots 
    SET current_bookings = current_bookings + 1
    WHERE id = ?;
    
    COMMIT;
ELSE
    ROLLBACK;
    RETURN ERROR "時段已額滿";
END IF;
```

### 11.3 資料一致性
- 預約建立成功後，需同時更新：
  1. `inspection_reservations` (預約單表)
  2. `inspection_time_slots` (時段預約數 +1)
  3. `unit_inspection_schedule` (戶別記錄預約日期與單號)

- 建議使用資料庫交易確保資料一致性

### 11.4 取消預約處理
- 取消預約時需：
  1. 更新預約單狀態為 `cancelled`
  2. 減少時段預約數 (`current_bookings - 1`)
  3. 清除戶別的預約記錄 (視業務需求決定)

---

## 十二、未來擴充建議

1. **簡訊/Email 通知**
   - 預約成功後發送確認通知
   - 預約前一天發送提醒通知

2. **QR Code 報到**
   - 產生預約 QR Code
   - 現場掃描確認身份

3. **候補機制**
   - 時段額滿時可登記候補
   - 有人取消時自動遞補通知

4. **智能推薦**
   - 根據歷史資料推薦較空閒時段
   - 平衡各時段預約數

5. **統計報表**
   - 各時段預約率統計
   - 戶別預約完成率
   - 熱門時段分析

---

## 文件修訂記錄

| 版本 | 日期 | 修訂者 | 修訂說明 |
|------|------|-------|---------|
| 1.0 | 2026-01-27 | AI Assistant | 初版建立 |

---

**附註**: 本文件為技術需求規格說明，實際開發時請依照團隊開發規範與資料庫設計進行調整。
