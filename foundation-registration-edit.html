<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>報名紀錄審核 - 陸府建設 CRM</title>
    
    <!-- Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS 樣式 -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/breadcrumb.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/pagination.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/foundation-event.css">
</head>
<body>
    <!-- ============================================ -->
    <!-- 主容器 -->
    <!-- ============================================ -->
    <div class="app-container">
        
        <!-- ============================================ -->
        <!-- 頂部導覽列 -->
        <!-- ============================================ -->
        <header class="header">
            <div class="header-left">
                <button class="header-toggle" id="sidebarToggle" title="展開/收合選單">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div class="header-brand">
                    <span class="header-title">CRM</span>
                </div>
            </div>
            <div class="header-right"></div>
        </header>

        <!-- ============================================ -->
        <!-- 側邊欄選單 -->
        <!-- ============================================ -->
        <aside class="sidebar" id="sidebar">
            <div class="main-container main-container-fixed">
                <div class="scrollable">
                    <ul class="menu-items">
                        <!-- 首頁 -->
                        <li class="menu-item" data-menu-id="home">
                            <a href="index.html" title="首頁">
                                <i class="menu-icon fa-solid fa-house"></i>
                                <span class="menu-title">首頁</span>
                            </a>
                        </li>

                        <!-- 系統管理 -->
                        <li class="menu-item" data-menu-id="system">
                            <a href="javascript:void(0)" title="系統管理">
                                <i class="menu-icon fa-solid fa-gear"></i>
                                <span class="menu-title">系統管理</span>
                                <i class="expand-state fa-solid fa-chevron-right"></i>
                            </a>
                            <ul class="menu-items">
                                <li class="menu-item"><a href="system-user.html" title="使用者管理"><span class="menu-title">使用者管理</span></a></li>
                                <li class="menu-item"><a href="system-role.html" title="角色權限管理"><span class="menu-title">角色權限管理</span></a></li>
                                <li class="menu-item"><a href="system-log.html" title="操作紀錄查詢"><span class="menu-title">操作紀錄查詢</span></a></li>
                            </ul>
                        </li>

                        <!-- 官網活動(基金會) -->
                        <li class="menu-item" data-menu-id="foundation">
                            <a href="javascript:void(0)" title="官網活動(基金會)">
                                <i class="menu-icon fa-solid fa-landmark"></i>
                                <span class="menu-title">官網活動(基金會)</span>
                                <i class="expand-state fa-solid fa-chevron-right"></i>
                            </a>
                            <ul class="menu-items">
                                <li class="menu-item"><a href="foundation-event-list.html" title="活動設定"><span class="menu-title">活動設定</span></a></li>
                                <li class="menu-item"><a href="foundation-registration.html" title="報名紀錄"><span class="menu-title">報名紀錄</span></a></li>
                                <li class="menu-item"><a href="foundation-audit-log.html" title="稽核日誌"><span class="menu-title">稽核日誌</span></a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- ============================================ -->
        <!-- 主內容區域 -->
        <!-- ============================================ -->
        <main class="main-content">
            <!-- 麵包屑導覽 -->
            <div class="breadcrumb">
                <a href="index.html" class="breadcrumb-item">
                    <i class="fa-solid fa-house"></i>
                    首頁
                </a>
                <span class="breadcrumb-separator">/</span>
                <a href="foundation-registration.html" class="breadcrumb-item">報名紀錄</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">報名審核</span>
            </div>

            <!-- 頁面內容 -->
            <div class="content-wrapper">
                <div class="page-header">
                    <h1 class="page-title">報名紀錄審核</h1>
                    <p class="page-subtitle">查看報名詳情並進行帳務處理</p>
                </div>

                <!-- 報名者資訊 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-user"></i>
                        報名者資訊
                    </h3>
                    <div class="detail-grid" id="registrantInfo">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 活動資訊 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-calendar-alt"></i>
                        活動資訊
                    </h3>
                    <div class="detail-grid" id="eventInfo">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 繳費狀態與操作 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-dollar-sign"></i>
                        繳費狀態
                    </h3>
                    <div id="paymentSection">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 操作日誌 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-history"></i>
                        操作日誌
                    </h3>
                    <div class="timeline" id="auditTimeline">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="form-actions" style="margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i class="fa-solid fa-arrow-left"></i>
                        返回列表
                    </button>
                    <button type="button" class="btn btn-danger" id="btnRefundRequest">
                        <i class="fa-solid fa-rotate-left"></i>
                        執行申請退款
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSave">
                        <i class="fa-solid fa-save"></i>
                        儲存
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================ -->
    <!-- 申請退款彈窗 -->
    <!-- ============================================ -->
    <div class="modal" id="refundModal" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">執行申請退款</h3>
                <button class="modal-close" onclick="closeModal('refundModal')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="margin-bottom: 16px;">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <span>退款操作將記錄於系統日誌</span>
                </div>
                <div class="form-group">
                    <label class="form-label">退款金額</label>
                    <div class="refund-amount" id="refundAmount">$0</div>
                </div>
                <div class="form-group">
                    <label class="form-label">退款備註說明 <span class="text-danger">*</span></label>
                    <textarea class="form-textarea" id="refundNote" rows="3" placeholder="請輸入退款原因或備註說明..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('refundModal')">取消</button>
                <button type="button" class="btn btn-danger" id="btnConfirmRefund">
                    <i class="fa-solid fa-check"></i>
                    確認退款
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- Toast 提示容器 -->
    <!-- ============================================ -->
    <div class="toast-container"></div>

    <!-- ============================================ -->
    <!-- JavaScript -->
    <!-- ============================================ -->
    <script src="js/sidebar.js"></script>
    <script src="js/foundation-mock-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const sidebarManager = new SidebarManager();
            
            // 從 URL 取得報名 ID
            const urlParams = new URLSearchParams(window.location.search);
            const regId = urlParams.get('id');
            
            // 取得報名資料
            const registration = regId 
                ? FoundationMockData.registrations.find(r => r.reg_id === regId)
                : FoundationMockData.registrations[0];
            
            // 取得活動資料
            const event = registration 
                ? FoundationMockData.getEventById(registration.event_id)
                : null;
            
            // 取得稽核日誌
            const auditLogs = registration 
                ? FoundationMockData.getAuditLogsByRegId(registration.reg_id)
                : [];
            
            if (registration && event) {
                renderRegistrantInfo(registration);
                renderEventInfo(event, registration);
                renderPaymentSection(registration, event);
                renderAuditTimeline(auditLogs);
                
                // 設定退款金額
                document.getElementById('refundAmount').textContent = '$' + registration.final_amount.toLocaleString();

                // 處理唯讀模式
                const isReadonly = urlParams.get('readonly') === 'true';
                if (isReadonly) {
                    // 修改標題
                    document.querySelector('.page-title').textContent = '報名紀錄詳情';
                    document.querySelector('.breadcrumb-item.active').textContent = '報名詳情';
                    
                    // 隱藏操作按鈕
                    const btnSave = document.getElementById('btnSave');
                    const btnRefundRequest = document.getElementById('btnRefundRequest');
                    if (btnSave) btnSave.style.display = 'none';
                    if (btnRefundRequest) btnRefundRequest.style.display = 'none';
                    
                    // 禁用所有表單元素與操作按鈕
                    setTimeout(() => {
                        const inputs = document.querySelectorAll('input, select, textarea, button'); 
                        inputs.forEach(input => {
                            // 排除返回按鈕
                            if (input.classList.contains('btn-secondary')) return;
                            // 確保不禁用 header 與 sidebar 的按鈕
                            if (input.closest('.header') || input.closest('.sidebar')) return;

                            input.disabled = true;
                        });
                        
                        // 移除可點擊的移除圖示或按鈕
                        const removeButtons = document.querySelectorAll('.fa-times, .btn-remove');
                        removeButtons.forEach(btn => {
                            // 排除 Modal 關閉按鈕
                            if(btn.closest('.modal-header') || btn.closest('.toast-close')) return;
                            btn.style.display = 'none'
                        });
                    }, 0);
                }
            }

            // 執行申請退款按鈕
            document.getElementById('btnRefundRequest').addEventListener('click', function() {
                openModal('refundModal');
            });

            // 確認退款
            document.getElementById('btnConfirmRefund').addEventListener('click', function() {
                const note = document.getElementById('refundNote').value;
                if (!note) {
                    showToast('error', '錯誤', '請輸入退款備註說明');
                    return;
                }
                closeModal('refundModal');
                
                // 模擬新增日誌
                const newLog = {
                    action: '申請退款',
                    changed_at: new Date().toISOString(),
                    changed_by: '財務人員',
                    old_value: '已付款',
                    new_value: '已退費',
                    note: note
                };
                auditLogs.unshift(newLog);
                renderAuditTimeline(auditLogs);
                
                // 更新狀態顯示 (模擬)
                registration.payment_status = '已退費';
                renderPaymentSection(registration, event);

                showToast('success', '退款申請已執行', '已更新狀態為已退費');
            });

            // 儲存按鈕
            document.getElementById('btnSave').addEventListener('click', function() {
                // 收集備註與附件資訊
                const remarks = document.getElementById('paymentRemarks')?.value;
                const fileInput = document.getElementById('evidenceFile');
                
                // 收集身分變更
                const identitySelect = document.getElementById('userIdentitySelect');
                if (identitySelect && registration) {
                    const newIdentity = identitySelect.value;
                    if (newIdentity !== registration.user_identity) {
                        const oldIdentity = registration.user_identity;
                        registration.user_identity = newIdentity;
                        
                        // 新增稽核日誌
                        const newLog = {
                            action: '修改身分',
                            changed_at: new Date().toISOString(),
                            changed_by: '管理人員',
                            old_value: oldIdentity,
                            new_value: newIdentity,
                            note: '手動變更身分別'
                        };
                        auditLogs.unshift(newLog);
                        renderAuditTimeline(auditLogs);
                    }
                }
                
                let message = '資料已儲存';
                if (fileInput && fileInput.files.length > 0) {
                    message += '，附件已上傳';
                }
                
                showToast('success', '儲存成功', message);
            });

            /**
             * 渲染報名者資訊
             */
            function renderRegistrantInfo(reg) {
                const container = document.getElementById('registrantInfo');
                const isResident = reg.user_identity === '住戶';
                
                container.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">報名編號</span>
                        <span class="detail-value">${reg.reg_id}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名者姓名</span>
                        <span class="detail-value">${reg.applicant_name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">身分識別</span>
                        <div class="detail-value" style="display: flex; align-items: center; gap: 8px;">
                            <select class="form-select" id="userIdentitySelect" style="width: auto; padding: 4px 8px;">
                                <option value="住戶" ${reg.user_identity === '住戶' ? 'selected' : ''}>住戶</option>
                                <option value="非住戶" ${reg.user_identity === '非住戶' ? 'selected' : ''}>非住戶</option>
                            </select>
                            <span id="identityBadgeDisplay">
                                ${isResident 
                                    ? '<span class="identity-badge resident"><i class="fa-solid fa-home"></i> 住戶</span>' 
                                    : '<span class="identity-badge non-resident"><i class="fa-solid fa-user"></i> 非住戶</span>'}
                            </span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">CRM 會員編號</span>
                        <span class="detail-value">${reg.crm_member_id || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">聯絡電話</span>
                        <span class="detail-value">${reg.phone}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">繳費方式</span>
                        <span class="detail-value">${reg.payment_method || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名人數</span>
                        <span class="detail-value">${reg.companion_count + 1} 人（本人 + ${reg.companion_count} 位同行）</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名時間</span>
                        <span class="detail-value">${formatDateTime(reg.created_at)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">需要收據</span>
                        <span class="detail-value">${reg.has_receipt ? '是' : '否'}</span>
                    </div>
                `;

                // 加入身分切換監聽器
                const identitySelect = document.getElementById('userIdentitySelect');
                const badgeDisplay = document.getElementById('identityBadgeDisplay');
                
                if (identitySelect && badgeDisplay) {
                    identitySelect.addEventListener('change', function() {
                        const isResident = this.value === '住戶';
                        badgeDisplay.innerHTML = isResident 
                            ? '<span class="identity-badge resident"><i class="fa-solid fa-home"></i> 住戶</span>' 
                            : '<span class="identity-badge non-resident"><i class="fa-solid fa-user"></i> 非住戶</span>';
                    });
                }
            }

            /**
             * 渲染活動資訊
             */
            function renderEventInfo(event, reg) {
                const container = document.getElementById('eventInfo');
                container.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">活動名稱</span>
                        <span class="detail-value">${event.title}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動類別</span>
                        <span class="detail-value"><span class="category-tag">${event.category}</span></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動時間</span>
                        <span class="detail-value">${formatDateTime(event.start_dt)} ~ ${formatDateTime(event.end_dt)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動費用</span>
                        <span class="detail-value">${event.price > 0 ? '$' + event.price.toLocaleString() : '免費'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">原始金額</span>
                        <span class="detail-value">$${reg.original_amount.toLocaleString()}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">最終金額</span>
                        <span class="detail-value" style="font-weight: 600; color: var(--color-info);">
                            $${reg.final_amount.toLocaleString()}
                        </span>
                    </div>
                `;
            }

            /**
             * 渲染繳費狀態區塊
             */
            function renderPaymentSection(reg, event) {
                const container = document.getElementById('paymentSection');
                
                let displayStatus = reg.payment_status;
                if (displayStatus === '已入帳') displayStatus = '已付款';
                if (displayStatus === '待繳費') displayStatus = '待付款';

                const statusClass = getPaymentStatusClass(displayStatus);
                
                let html = `
                    <div class="payment-card">
                        <div class="payment-card-header">
                            <div class="payment-status-info">
                                <span class="payment-status ${statusClass}">${displayStatus}</span>
                                <span class="payment-amount">$${reg.final_amount.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="payment-card-body">
                `;
                
                if (displayStatus === '待付款') {
                    html += `
                        <p class="payment-hint">報名者尚未完成繳費</p>
                        <div class="payment-actions">
                             <button class="btn btn-outline btn-sm" onclick="confirmPayment()">
                                <i class="fa-solid fa-check"></i> 手動確認繳費
                            </button>
                        </div>
                    `;
                } else if (displayStatus === '已付款') {
                    html += `
                        <div class="payment-detail">
                            <span class="payment-detail-label">繳費方式</span>
                            <span class="payment-detail-value">${reg.payment_method || '-'}</span>
                        </div>
                    `;
                    
                    if (reg.payment_method === '現金' || reg.payment_method === '現場繳費' || reg.payment_method === '匯款') {
                         html += `
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">佐證資料附件</label>
                            <input type="file" class="form-control" id="evidenceFile">
                            <p class="text-muted" style="font-size: 12px; margin-top: 4px;">支援格式：JPG, PNG, PDF</p>
                        </div>
                        `;
                    }

                    html += `
                        <div class="form-group" style="margin-top: 16px;">
                            <label class="form-label">備註說明</label>
                            <textarea class="form-textarea" id="paymentRemarks" rows="3" placeholder="請輸入備註..."></textarea>
                        </div>
                    `;

                } else if (displayStatus === '已退費') {
                    html += `
                        <div class="payment-detail">
                            <span class="payment-detail-label">退款金額</span>
                            <span class="payment-detail-value">$${reg.final_amount.toLocaleString()}</span>
                        </div>
                        <p class="text-muted" style="margin-top: 12px;">已完成退費程序</p>
                    `;
                }
                
                html += '</div></div>';
                container.innerHTML = html;
            }

            /**
             * 渲染稽核時間軸
             */
            function renderAuditTimeline(logs) {
                const container = document.getElementById('auditTimeline');
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-muted">尚無操作紀錄</p>';
                    return;
                }
                
                container.innerHTML = logs.map(log => `
                    <div class="timeline-item">
                        <div class="timeline-marker ${getActionClass(log.action)}">
                            <i class="fa-solid ${getActionIcon(log.action)}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-action">${log.action}</span>
                                <span class="timeline-time">${formatDateTime(log.changed_at)}</span>
                            </div>
                            <div class="timeline-body">
                                <p><strong>操作者：</strong>${log.changed_by}</p>
                                ${log.old_value || log.new_value ? `
                                    <p><strong>變更內容：</strong></p>
                                    <div class="change-comparison">
                                        ${log.old_value ? `<span class="old-value">${log.old_value}</span>` : ''}
                                        ${log.old_value && log.new_value ? '<i class="fa-solid fa-arrow-right"></i>' : ''}
                                        ${log.new_value ? `<span class="new-value">${log.new_value}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${log.note ? `<p style="margin-top:8px;"><strong>備註：</strong>${log.note}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            /**
             * 取得繳費狀態樣式類別
             */
            function getPaymentStatusClass(status) {
                const map = {
                    '待繳費': 'pending',
                    '待付款': 'pending',
                    '已入帳': 'paid',
                    '已付款': 'paid',
                    '已退費': 'refunding',
                    '已取消': 'cancelled'
                };
                if (status === '已退費') return 'cancelled';
                return map[status] || '';
            }

            /**
             * 取得操作類型樣式類別
             */
            function getActionClass(action) {
                if (action.includes('報名')) return 'action-register';
                if (action.includes('繳費')) return 'action-payment';
                if (action.includes('退款')) return 'action-refund';
                if (action.includes('通知')) return 'action-notify';
                return 'action-other';
            }

            /**
             * 取得操作類型圖示
             */
            function getActionIcon(action) {
                if (action.includes('報名')) return 'fa-user-plus';
                if (action.includes('繳費')) return 'fa-dollar-sign';
                if (action.includes('退款')) return 'fa-rotate-left';
                if (action.includes('通知')) return 'fa-paper-plane';
                return 'fa-edit';
            }

            /**
             * 格式化日期時間
             */
            function formatDateTime(dateStr) {
                const date = new Date(dateStr);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            // 將函式暴露到全域
            window.confirmPayment = function() {
                if (confirm('確定要手動確認此筆報名已繳費嗎？')) {
                    showToast('success', '繳費確認成功', '報名狀態已更新為已付款');
                    setTimeout(() => location.reload(), 1500);
                }
            };

            window.openRefundModal = function() {
                // Not used via button anymore, but kept just in case
                document.getElementById('refundAmount').textContent = '$' + registration.final_amount.toLocaleString();
                openModal('refundModal');
            };

            // Remove openRefundModal if it's not needed, but leave for safety if I missed referencing it in previous blocks.
            // Actually button calls openModal directly now.
        });

        /**
         * 開啟彈窗
         */
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        /**
         * 關閉彈窗
         */
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        /**
         * 顯示提示訊息
         */
        function showToast(type, title, message) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `
                <div class="toast-icon">
                    <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-exclamation-circle'}"></i>
                </div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <i class="fa-solid fa-times"></i>
                </button>
            `;
            
            let container = document.querySelector('.toast-container');
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }
    </script>

    <!-- 頁面專用樣式 -->
    <style>
        .page-subtitle { color: var(--color-text-muted); margin-top: 8px; }
        .text-muted { color: var(--color-text-muted); }
        .text-danger { color: var(--color-danger); }

        /* Toast 樣式 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 450px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-icon { font-size: 20px; }
        .toast-success .toast-icon { color: #27AE60; }
        .toast-error .toast-icon { color: #E74C3C; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 4px; }
        .toast-message { font-size: 14px; color: #666; }
        .toast-close { background: none; border: none; cursor: pointer; color: #999; padding: 0; }

        /* 詳情區塊 */
        .detail-section {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .detail-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .detail-section-title i {
            color: var(--color-primary);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .detail-value {
            font-size: 15px;
            color: var(--color-text-primary);
        }

        /* 繳費卡片 */
        .payment-card {
            background: var(--color-gray-100);
            border-radius: 8px;
            overflow: hidden;
        }

        .payment-card-header {
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid var(--color-border);
        }

        .payment-status-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .payment-card-body {
            padding: 20px;
        }

        .payment-hint {
            margin: 0 0 16px 0;
            color: var(--color-text-secondary);
        }

        .payment-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .payment-detail {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .payment-detail-label {
            color: var(--color-text-muted);
            min-width: 80px;
        }

        .payment-detail-value {
            color: var(--color-text-primary);
        }

        /* 退款區塊 */
        .refund-info {
            display: flex;
            align-items: center;
            gap: 24px;
            flex-wrap: wrap;
        }

        .refund-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 500;
        }

        .refund-available {
            background: #e8f5e9;
            color: #388e3c;
        }

        .refund-expired {
            background: #ffebee;
            color: #c62828;
        }

        .refund-detail {
            flex: 1;
            min-width: 200px;
        }

        .refund-detail p {
            margin: 0 0 8px 0;
            color: var(--color-text-secondary);
        }

        .refund-progress {
            height: 8px;
            background: var(--color-gray-300);
            border-radius: 4px;
            overflow: hidden;
        }

        .refund-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #27ae60, #f39c12);
            transition: width 0.3s;
        }

        .refund-progress-label {
            font-size: 12px;
            color: var(--color-text-muted);
        }

        .refund-warning-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #fff3e0;
            color: #e65100;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 8px;
        }

        /* 時間軸 */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-marker {
            position: absolute;
            left: -30px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
            background: var(--color-gray-500);
        }

        .timeline-marker.action-register { background: #3498db; }
        .timeline-marker.action-payment { background: #27ae60; }
        .timeline-marker.action-refund { background: #e74c3c; }
        .timeline-marker.action-notify { background: #9b59b6; }

        .timeline-content {
            background: var(--color-gray-100);
            border-radius: 8px;
            padding: 16px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timeline-action {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .timeline-time {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .timeline-body p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .change-comparison {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .old-value {
            padding: 4px 8px;
            background: #ffebee;
            color: #c62828;
            border-radius: 4px;
            font-size: 13px;
            text-decoration: line-through;
        }

        .new-value {
            padding: 4px 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 4px;
            font-size: 13px;
        }

        /* 彈窗額外樣式 */
        .alert {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .refund-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-danger);
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-label input {
            width: 18px;
            height: 18px;
        }

        /* 按鈕樣式補充 */
        .btn-info {
            background-color: var(--color-info);
            color: #fff;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .btn-outline:hover {
            background: var(--color-gray-100);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* 表單操作區 */
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
    </style>
</body>
</html>
