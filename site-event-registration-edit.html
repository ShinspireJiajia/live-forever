<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>案場活動報名紀錄審核 - 陸府建設 CRM</title>
    
    <!-- Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS 樣式 -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/breadcrumb.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/pagination.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/site-event.css">
    <style>
        /* 附件上傳區塊樣式 */
        .file-upload-area {
            position: relative;
            border: 2px dashed var(--color-gray-300);
            border-radius: var(--border-radius-md);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            background-color: var(--color-gray-100);
        }
        .file-upload-area:hover {
            border-color: var(--color-info);
            background-color: rgba(91, 155, 213, 0.05);
        }
        .file-upload-area.dragover {
            border-color: var(--color-info);
            background-color: rgba(91, 155, 213, 0.1);
        }
        .file-upload-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .file-upload-content {
            pointer-events: none;
        }
        /* 已上傳檔案列表 */
        .uploaded-files-list {
            margin-top: 12px;
        }
        .uploaded-file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: var(--color-gray-100);
            border-radius: var(--border-radius-sm);
            margin-bottom: 8px;
        }
        .uploaded-file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .uploaded-file-info i {
            color: var(--color-info);
        }
        .uploaded-file-name {
            font-size: 14px;
            color: var(--color-gray-700);
        }
        .uploaded-file-size {
            font-size: 12px;
            color: var(--color-gray-500);
            margin-left: 8px;
        }
        .btn-remove-file {
            background: none;
            border: none;
            color: var(--color-danger);
            cursor: pointer;
            padding: 4px;
            font-size: 14px;
        }
        .btn-remove-file:hover {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <!-- ============================================ -->
    <!-- 主容器 -->
    <!-- ============================================ -->
    <div class="app-container">
        
        <!-- ============================================ -->
        <!-- 頂部導覽列 (動態渲染) -->
        <!-- ============================================ -->
        <div id="header-container"></div>

        <!-- ============================================ -->
        <!-- 側邊欄選單 (動態渲染) -->
        <!-- ============================================ -->
        <div id="sidebar-container"></div>

        <!-- ============================================ -->
        <!-- 主內容區域 -->
        <!-- ============================================ -->
        <main class="main-content">
            <!-- 麵包屑導覽 -->
            <div class="breadcrumb">
                <a href="index.html" class="breadcrumb-item">
                    <i class="fa-solid fa-house"></i>
                    首頁
                </a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item">案場活動</span>
                <span class="breadcrumb-separator">/</span>
                <a href="site-event-registration.html" class="breadcrumb-item">報名紀錄</a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">報名審核</span>
            </div>

            <!-- 頁面內容 -->
            <div class="content-wrapper">
                <div class="page-header">
                    <h1 class="page-title">報名紀錄</h1>
                    <p class="page-subtitle">查看報名詳情</p>
                </div>

                <!-- 報名者資訊 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-user"></i>
                        報名者資訊
                    </h3>
                    <div class="detail-grid" id="registrantInfo">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 活動資訊 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-calendar-alt"></i>
                        活動資訊
                    </h3>
                    <div class="detail-grid" id="eventInfo">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 繳費狀態與操作 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-dollar-sign"></i>
                        繳費狀態
                    </h3>
                    <div id="paymentSection">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 操作日誌 -->
                <div class="detail-section">
                    <h3 class="detail-section-title">
                        <i class="fa-solid fa-history"></i>
                        操作日誌
                    </h3>
                    <div class="timeline" id="auditTimeline">
                        <!-- JavaScript 動態產生 -->
                    </div>
                </div>

                <!-- 操作按鈕 -->
                <div class="form-actions" style="margin-top: 24px;">
                    <button type="button" class="btn btn-secondary" onclick="history.back()">
                        <i class="fa-solid fa-arrow-left"></i>
                        返回列表
                    </button>
                    <button type="button" class="btn btn-danger" id="btnRefundRequest">
                        <i class="fa-solid fa-rotate-left"></i>
                        取消報名
                    </button>
                    <button type="button" class="btn btn-primary" id="btnSave">
                        <i class="fa-solid fa-save"></i>
                        儲存
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- ============================================ -->
    <!-- 申請退款彈窗 -->
    <!-- ============================================ -->
    <div class="modal" id="refundModal" style="background-color: rgba(0, 0, 0, 0.5);">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">取消報名</h3>
                <button class="modal-close" onclick="closeModal('refundModal')">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning" style="margin-bottom: 16px;">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <span>操作將記錄於系統日誌</span>
                </div>
                <div class="form-group">
                    <label class="form-label">應退款金額</label>
                    <div class="refund-amount" id="refundAmount">$0</div>
                </div>
                <div class="form-group">
                    <label class="form-label">備註說明 <span class="text-danger">*</span></label>
                    <textarea class="form-textarea" id="refundNote" rows="3" placeholder="請輸入備註說明..."></textarea>
                </div>
                <!-- 附件上傳區塊 -->
                <div class="form-group">
                    <label class="form-label">附件上傳</label>
                    <div class="file-upload-area" id="refundFileDropZone">
                        <input type="file" class="file-upload-input" id="refundFileInput" multiple accept=".jpg,.jpeg,.pdf">
                        <div class="file-upload-content">
                            <i class="fa-solid fa-cloud-upload-alt" style="font-size: 32px; color: var(--color-gray-500); margin-bottom: 8px;"></i>
                            <p style="margin: 0; color: var(--color-gray-700);">點擊或拖曳檔案至此處上傳</p>
                            <p style="margin: 4px 0 0; font-size: 12px; color: var(--color-gray-500);">支援格式：JPG, PDF（單檔最大 10MB）</p>
                        </div>
                    </div>
                    <!-- 已上傳檔案列表 -->
                    <div class="uploaded-files-list" id="refundUploadedFiles"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('refundModal')">取消</button>
                <button type="button" class="btn btn-danger" id="btnConfirmRefund">
                    <i class="fa-solid fa-check"></i>
                    確認退款
                </button>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- Toast 提示容器 -->
    <!-- ============================================ -->
    <div class="toast-container"></div>

    <!-- ============================================ -->
    <!-- JavaScript -->
    <!-- ============================================ -->
    <script src="js/menu-component.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/site-event-mock-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 渲染共用元件
            if (typeof initCRMLayout === 'function') {
                initCRMLayout();
            }
            
            // 初始化側邊欄
            const sidebarManager = new SidebarManager();
            
            // 從 URL 取得報名 ID
            const urlParams = new URLSearchParams(window.location.search);
            const regId = urlParams.get('id');
            
            // 取得報名資料
            const registration = regId 
                ? SiteEventMockData.registrations.find(r => r.reg_id === regId)
                : SiteEventMockData.registrations[3]; // Default to one with a fee for demo
            
            // 取得活動資料
            const event = registration 
                ? SiteEventMockData.events.find(e => e.event_id === registration.event_id)
                : null;
            
            // 產生模擬稽核日誌 (因為 SiteEventMockData 沒有)
            const auditLogs = registration ? [
                {
                    action: '建立報名',
                    changed_at: registration.created_at,
                    changed_by: registration.applicant_name,
                    note: '自行報名'
                }
            ] : [];

            if (registration && registration.payment_status === '已繳費' && registration.amount > 0) {
                 auditLogs.unshift({
                    action: '完成繳費',
                    changed_at: new Date(new Date(registration.created_at).getTime() + 3600000).toISOString(),
                    changed_by: '系統',
                    note: '信用卡支付成功'
                });
            }
            
            if (registration && event) {
                renderRegistrantInfo(registration);
                renderEventInfo(event, registration);
                renderPaymentSection(registration, event);
                renderAuditTimeline(auditLogs);
                
                // 設定退款金額
                const amount = registration.amount || 0;
                document.getElementById('refundAmount').textContent = '$' + amount.toLocaleString();

                // 處理唯讀模式
                const isReadonly = urlParams.get('readonly') === 'true';
                if (isReadonly) {
                    // 修改標題
                    document.querySelector('.page-title').textContent = '報名紀錄詳情';
                    document.querySelector('.breadcrumb-item.active').textContent = '報名詳情';
                    
                    // 隱藏操作按鈕
                    const btnSave = document.getElementById('btnSave');
                    const btnRefundRequest = document.getElementById('btnRefundRequest');
                    if (btnSave) btnSave.style.display = 'none';
                    if (btnRefundRequest) btnRefundRequest.style.display = 'none';
                    
                    // 禁用主內容區的表單元素（排除彈窗內的元素）
                    setTimeout(() => {
                        const mainContent = document.querySelector('.main-content');
                        if (mainContent) {
                            const inputs = mainContent.querySelectorAll('input, select, textarea, button'); 
                            inputs.forEach(input => {
                                if (input.classList.contains('btn-secondary')) return;
                                if (input.closest('.header') || input.closest('.sidebar')) return;
                                if (input.closest('.modal')) return; // 排除彈窗內的元素
                                input.disabled = true;
                            });
                        }
                    }, 0);
                }
            }

            // 附件上傳功能初始化
            initRefundFileUpload();

            // 執行取消報名按鈕
            document.getElementById('btnRefundRequest').addEventListener('click', function() {
                openModal('refundModal');
            });

            // 確認退款
            document.getElementById('btnConfirmRefund').addEventListener('click', function() {
                const note = document.getElementById('refundNote').value;
                if (!note) {
                    showToast('error', '錯誤', '請輸入退款備註說明');
                    return;
                }
                closeModal('refundModal');
                
                const newLog = {
                    action: '申請退款',
                    changed_at: new Date().toISOString(),
                    changed_by: '財務人員',
                    old_value: '已付款',
                    new_value: '已退費',
                    note: note
                };
                auditLogs.unshift(newLog);
                renderAuditTimeline(auditLogs);
                
                registration.payment_status = '已退費';
                renderPaymentSection(registration, event);

                showToast('success', '退款申請已執行', '已更新狀態為已退費');
            });

            // 儲存按鈕
            document.getElementById('btnSave').addEventListener('click', function() {
                let message = '資料已儲存';
                
                // 檢查是否上傳附件
                const fileInput = document.getElementById('evidenceFile');
                if (fileInput && fileInput.files.length > 0) {
                    message += '，附件已上傳';
                }
                
                showToast('success', '儲存成功', message);
            });

            /**
             * 初始化退款附件上傳功能
             */
            function initRefundFileUpload() {
                const dropZone = document.getElementById('refundFileDropZone');
                const fileInput = document.getElementById('refundFileInput');
                const fileListContainer = document.getElementById('refundUploadedFiles');
                let uploadedFiles = [];

                if (!dropZone || !fileInput || !fileListContainer) return;

                // 拖曳事件
                dropZone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropZone.classList.add('dragover');
                });

                dropZone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                });

                dropZone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropZone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    handleFiles(files);
                });

                // 檔案選取事件
                fileInput.addEventListener('change', function(e) {
                    handleFiles(e.target.files);
                });

                /**
                 * 處理選取的檔案
                 */
                function handleFiles(files) {
                    const validExtensions = ['.jpg', '.jpeg', '.pdf'];
                    const maxSize = 10 * 1024 * 1024; // 10MB

                    for (let i = 0; i < files.length; i++) {
                        const file = files[i];
                        const ext = '.' + file.name.split('.').pop().toLowerCase();

                        // 驗證檔案格式
                        if (!validExtensions.includes(ext)) {
                            showToast('error', '格式錯誤', `檔案 "${file.name}" 格式不支援，僅支援 JPG、PDF`);
                            continue;
                        }

                        // 驗證檔案大小
                        if (file.size > maxSize) {
                            showToast('error', '檔案過大', `檔案 "${file.name}" 超過 10MB 限制`);
                            continue;
                        }

                        // 檢查是否重複
                        const isDuplicate = uploadedFiles.some(f => f.name === file.name && f.size === file.size);
                        if (isDuplicate) {
                            showToast('warning', '重複檔案', `檔案 "${file.name}" 已存在`);
                            continue;
                        }

                        uploadedFiles.push(file);
                    }

                    renderFileList();
                    // 清空 input 以便重複選取同一檔案
                    fileInput.value = '';
                }

                /**
                 * 渲染已上傳檔案列表
                 */
                function renderFileList() {
                    if (uploadedFiles.length === 0) {
                        fileListContainer.innerHTML = '';
                        return;
                    }

                    fileListContainer.innerHTML = uploadedFiles.map((file, index) => {
                        const ext = file.name.split('.').pop().toLowerCase();
                        const icon = ext === 'pdf' ? 'fa-file-pdf' : 'fa-file-image';
                        const size = formatFileSize(file.size);

                        return `
                            <div class="uploaded-file-item" data-index="${index}">
                                <div class="uploaded-file-info">
                                    <i class="fa-solid ${icon}"></i>
                                    <span class="uploaded-file-name">${file.name}</span>
                                    <span class="uploaded-file-size">(${size})</span>
                                </div>
                                <button type="button" class="btn-remove-file" onclick="removeRefundFile(${index})" title="移除檔案">
                                    <i class="fa-solid fa-times"></i>
                                </button>
                            </div>
                        `;
                    }).join('');
                }

                /**
                 * 格式化檔案大小
                 */
                function formatFileSize(bytes) {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                }

                // 將移除檔案功能暴露到全域
                window.removeRefundFile = function(index) {
                    uploadedFiles.splice(index, 1);
                    renderFileList();
                };

                // 取得已上傳檔案（供提交時使用）
                window.getRefundUploadedFiles = function() {
                    return uploadedFiles;
                };
            }

            /**
             * 渲染報名者資訊
             */
            function renderRegistrantInfo(reg) {
                const container = document.getElementById('registrantInfo');
                
                // 固定顯示住戶身分，不可變更
                const identityDisplay = `
                    <div class="detail-value" style="display: flex; align-items: center; gap: 8px;">
                        <span class="identity-badge resident"><i class="fa-solid fa-home"></i> 住戶</span>
                        <span class="text-muted" style="font-size: 0.9em;">(${reg.site_name} ${reg.unit_no})</span>
                    </div>
                `;

                container.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">報名編號</span>
                        <span class="detail-value">${reg.reg_id}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名者姓名</span>
                        <span class="detail-value">${reg.applicant_name}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">身分識別</span>
                        ${identityDisplay}
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">會員編號</span>
                        <span class="detail-value">${reg.member_id || '-'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">聯絡電話</span>
                        <span class="detail-value">${reg.phone}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">繳費方式</span>
                        <span class="detail-value">${reg.payment_method || (reg.amount > 0 ? '待繳費' : '免費')}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名人數</span>
                        <span class="detail-value">${reg.companion_count + 1} 人（本人 + ${reg.companion_count} 位同行）</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">報名時間</span>
                        <span class="detail-value">${formatDateTime(reg.created_at)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">需要收據</span>
                        <span class="detail-value">
                            ${reg.has_receipt ? '是' : '否'}
                            ${reg.has_receipt ? `
                                <a href="foundation-receipt-edit.html?receiptNo=${reg.receipt_no || ''}&donorName=${encodeURIComponent(reg.applicant_name)}&amount=${reg.amount}&payMethod=${encodeURIComponent(reg.payment_method || '')}" 
                                   class="btn btn-sm btn-outline" 
                                   style="margin-left: 8px; text-decoration: none; display: inline-flex; align-items: center; gap: 4px;">
                                    <i class="fa-solid fa-file-invoice-dollar"></i> 編輯收據
                                </a>` 
                            : ''}
                        </span>
                    </div>
                `;
            }

            /**
             * 渲染活動資訊
             */
            function renderEventInfo(event, reg) {
                const container = document.getElementById('eventInfo');
                const price = event.price || 0;
                const totalAmount = reg.amount || 0;

                container.innerHTML = `
                    <div class="detail-item">
                        <span class="detail-label">活動名稱</span>
                        <span class="detail-value">${event.title}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動類別</span>
                        <span class="detail-value"><span class="category-tag site-event">${event.category}</span></span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動時間</span>
                        <span class="detail-value">${formatDateTime(event.start_dt)} ~ ${formatDateTime(event.end_dt)}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動地點</span>
                        <span class="detail-value">${event.location}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">活動費用</span>
                        <span class="detail-value">${price > 0 ? '$' + price.toLocaleString() : '免費'}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">應付金額</span>
                        <span class="detail-value" style="font-weight: 600; color: var(--color-info);">
                            $${totalAmount.toLocaleString()}
                        </span>
                    </div>
                `;
            }

            /**
             * 渲染繳費狀態區塊
             */
            function renderPaymentSection(reg, event) {
                const container = document.getElementById('paymentSection');
                
                let displayStatus = reg.payment_status;
                if (!displayStatus) {
                     displayStatus = (reg.amount > 0) ? '待付款' : '已付款'; 
                     // 免費視為已付款(已完成)
                     if (reg.amount === 0) displayStatus = '已付款';
                }

                if (displayStatus === '已入帳') displayStatus = '已付款';
                if (displayStatus === '待繳費') displayStatus = '待付款';
                // 未繳費 -> 待付款
                if (displayStatus === '未繳費') displayStatus = '待付款';

                const statusClass = getPaymentStatusClass(displayStatus);
                const amount = reg.amount || 0;
                
                let html = `
                    <div class="payment-card">
                        <div class="payment-card-header">
                            <div class="payment-status-info">
                                <span class="payment-status ${statusClass}">${displayStatus}</span>
                                <span class="payment-amount">$${amount.toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="payment-card-body">
                `;
                
                if (displayStatus === '待付款') {
                    html += `
                        <p class="payment-hint">報名者尚未完成繳費</p>
                        <div class="payment-actions">
                             <button class="btn btn-outline btn-sm" onclick="confirmPayment()">
                                <i class="fa-solid fa-check"></i> 手動確認繳費
                            </button>
                        </div>
                    `;
                } else if (displayStatus === '已付款') {
                    if (amount > 0) {
                        html += `
                            <div class="payment-detail">
                                <span class="payment-detail-label">繳費方式</span>
                                <span class="payment-detail-value">${reg.payment_method || '-'}</span>
                            </div>
                            
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-label">佐證資料附件</label>
                                <input type="file" class="form-control" id="evidenceFile">
                                <p class="text-muted" style="font-size: 12px; margin-top: 4px;">支援格式：JPG, PNG, PDF</p>
                            </div>
                            <div class="form-group" style="margin-top: 16px;">
                                <label class="form-label">備註說明</label>
                                <textarea class="form-textarea" id="paymentRemarks" rows="3" placeholder="請輸入備註..."></textarea>
                            </div>
                        `;
                    } else {
                         html += `
                            <p class="payment-hint">此為免費活動</p>
                        `;
                    }

                } else if (displayStatus === '已退費') {
                    html += `
                        <div class="payment-detail">
                            <span class="payment-detail-label">退款金額</span>
                            <span class="payment-detail-value">$${amount.toLocaleString()}</span>
                        </div>
                        <p class="text-muted" style="margin-top: 12px;">已完成退費程序</p>
                    `;
                } else if (displayStatus === '已取消') {
                     html += `
                        <p class="text-muted" style="margin-top: 0px;">報名已取消</p>
                    `;
                }
                
                html += '</div></div>';
                container.innerHTML = html;
            }

            /**
             * 渲染稽核時間軸
             */
            function renderAuditTimeline(logs) {
                const container = document.getElementById('auditTimeline');
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-muted">尚無操作紀錄</p>';
                    return;
                }
                
                container.innerHTML = logs.map(log => `
                    <div class="timeline-item">
                        <div class="timeline-marker ${getActionClass(log.action)}">
                            <i class="fa-solid ${getActionIcon(log.action)}"></i>
                        </div>
                        <div class="timeline-content">
                            <div class="timeline-header">
                                <span class="timeline-action">${log.action}</span>
                                <span class="timeline-time">${formatDateTime(log.changed_at)}</span>
                            </div>
                            <div class="timeline-body">
                                <p><strong>操作者：</strong>${log.changed_by}</p>
                                ${log.old_value || log.new_value ? `
                                    <p><strong>變更內容：</strong></p>
                                    <div class="change-comparison">
                                        ${log.old_value ? `<span class="old-value">${log.old_value}</span>` : ''}
                                        ${log.old_value && log.new_value ? '<i class="fa-solid fa-arrow-right"></i>' : ''}
                                        ${log.new_value ? `<span class="new-value">${log.new_value}</span>` : ''}
                                    </div>
                                ` : ''}
                                ${log.note ? `<p style="margin-top:8px;"><strong>備註：</strong>${log.note}</p>` : ''}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            function getPaymentStatusClass(status) {
                const map = {
                    '待繳費': 'pending',
                    '待付款': 'pending',
                    '未繳費': 'pending',
                    '已入帳': 'paid',
                    '已付款': 'paid',
                    '已退費': 'refunding',
                    '已取消': 'cancelled'
                };
                return map[status] || '';
            }

            function getActionClass(action) {
                if (action.includes('報名')) return 'action-register';
                if (action.includes('繳費')) return 'action-payment';
                if (action.includes('退款')) return 'action-refund';
                if (action.includes('通知')) return 'action-notify';
                return 'action-other';
            }

            function getActionIcon(action) {
                if (action.includes('報名')) return 'fa-user-plus';
                if (action.includes('繳費')) return 'fa-dollar-sign';
                if (action.includes('退款')) return 'fa-rotate-left';
                if (action.includes('通知')) return 'fa-paper-plane';
                return 'fa-edit';
            }

            function formatDateTime(dateStr) {
                if (!dateStr) return '-';
                const date = new Date(dateStr);
                return date.toLocaleString('zh-TW', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

            window.confirmPayment = function() {
                if (confirm('確定要手動確認此筆報名已繳費嗎？')) {
                    showToast('success', '繳費確認成功', '報名狀態已更新為已付款');
                    setTimeout(() => location.reload(), 1500);
                }
            };
            
            window.openModal = function(id) {
                document.getElementById(id).classList.add('active');
            }
            window.closeModal = function(id) {
                document.getElementById(id).classList.remove('active');
            }
            
            window.showToast = function(type, title, message) {
                 const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-times-circle' : 'fa-exclamation-circle'}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-title">${title}</div>
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                `;
                
                let container = document.querySelector('.toast-container');
                container.appendChild(toast);
                
                setTimeout(() => toast.remove(), 5000);
            }
        });
    </script>

    <!-- 頁面專用樣式 -->
    <style>
        .page-subtitle { color: var(--color-text-muted); margin-top: 8px; }
        .text-muted { color: var(--color-text-muted); }
        .text-danger { color: var(--color-danger); }

        /* Toast 樣式 */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 300px;
            max-width: 450px;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-icon { font-size: 20px; }
        .toast-success .toast-icon { color: #27AE60; }
        .toast-error .toast-icon { color: #E74C3C; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 600; margin-bottom: 4px; }
        .toast-message { font-size: 14px; color: #666; }
        .toast-close { background: none; border: none; cursor: pointer; color: #999; padding: 0; }

        /* 詳情區塊 */
        .detail-section {
            background: #fff;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .detail-section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 600;
            color: var(--color-text-primary);
            margin: 0 0 16px 0;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--color-border);
        }

        .detail-section-title i {
            color: var(--color-primary);
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .detail-label {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .detail-value {
            font-size: 15px;
            color: var(--color-text-primary);
        }
        
        /* 身份標籤 */
        .identity-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
        }

        .identity-badge.resident {
            background-color: #e8f5e9;
            color: #2e7d32;
        }

        /* 繳費卡片 */
        .payment-card {
            background: var(--color-gray-100);
            border-radius: 8px;
            overflow: hidden;
        }

        .payment-card-header {
            padding: 16px 20px;
            background: #fff;
            border-bottom: 1px solid var(--color-border);
        }

        .payment-status-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .payment-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }

        .payment-status.paid {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .payment-status.pending {
            background: #fff3e0;
            color: #ef6c00;
        }

        .payment-status.refunding {
            background: #ffebee;
            color: #c62828;
        }
        
        .payment-status.cancelled {
             background: #f5f5f5;
             color: #9e9e9e;
        }

        .payment-amount {
            font-size: 24px;
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .payment-card-body {
            padding: 20px;
        }

        .payment-hint {
            margin: 0 0 16px 0;
            color: var(--color-text-secondary);
        }

        .payment-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .payment-detail {
            display: flex;
            gap: 12px;
            margin-bottom: 8px;
        }

        .payment-detail-label {
            color: var(--color-text-muted);
            min-width: 80px;
        }

        .payment-detail-value {
            color: var(--color-text-primary);
        }

        /* 時間軸 */
        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--color-border);
        }

        .timeline-item {
            position: relative;
            padding-bottom: 24px;
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-marker {
            position: absolute;
            left: -30px;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #fff;
            background: var(--color-gray-500);
        }

        .timeline-marker.action-register { background: #3498db; }
        .timeline-marker.action-payment { background: #27ae60; }
        .timeline-marker.action-refund { background: #e74c3c; }
        .timeline-marker.action-notify { background: #9b59b6; }

        .timeline-content {
            background: var(--color-gray-100);
            border-radius: 8px;
            padding: 16px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .timeline-action {
            font-weight: 600;
            color: var(--color-text-primary);
        }

        .timeline-time {
            font-size: 13px;
            color: var(--color-text-muted);
        }

        .timeline-body p {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--color-text-secondary);
        }

        .change-comparison {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: 8px;
        }

        .old-value {
            padding: 4px 8px;
            background: #ffebee;
            color: #c62828;
            border-radius: 4px;
            font-size: 13px;
            text-decoration: line-through;
        }

        .new-value {
            padding: 4px 8px;
            background: #e8f5e9;
            color: #2e7d32;
            border-radius: 4px;
            font-size: 13px;
        }

        /* 彈窗額外樣式 */
        .alert {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            border-radius: 8px;
        }

        .alert-warning {
            background: #fff3e0;
            color: #e65100;
        }

        .refund-amount {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-danger);
        }

        /* 按鈕樣式補充 */
        .btn-info {
            background-color: var(--color-info);
            color: #fff;
        }

        .btn-info:hover {
            background-color: #2980b9;
        }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }

        .btn-outline:hover {
            background: var(--color-gray-100);
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* 表單操作區 */
        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .category-tag.site-event {
            background-color: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
    </style>
</body>
</html>