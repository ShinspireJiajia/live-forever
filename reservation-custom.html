<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>客變預約 - 陸府建設 CRM</title>
    
    <!-- Font Awesome 圖示 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- CSS 樣式 -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/sidebar.css">
    <link rel="stylesheet" href="css/breadcrumb.css">
    <link rel="stylesheet" href="css/buttons.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/tables.css">
    <link rel="stylesheet" href="css/pagination.css">
    <link rel="stylesheet" href="css/modals.css">
    <link rel="stylesheet" href="css/reservation-handover.css">
    <link rel="stylesheet" href="css/reservation-collateral.css">
    <link rel="stylesheet" href="css/case-list.css">
    <link rel="stylesheet" href="css/case-edit.css">
    <link rel="stylesheet" href="css/reservation-custom.css">
    <link rel="stylesheet" href="css/chat.css">
</head>
<body>
    <div class="app-container">
        <!-- 頂部導覽列 -->
                <div id="header-container"></div>

        <!-- 側邊欄選單 -->
        <!-- ============================================ -->
        <div id="sidebar-container"></div>


        <!-- ============================================ -->
        <!-- 主內容區域 -->
        <main class="main-content">
            <div class="breadcrumb">
                <a href="index.html" class="breadcrumb-item">
                    <i class="fa-solid fa-house"></i>
                    首頁
                </a>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item active">客變預約</span>
            </div>

            <div class="content-wrapper">
                <div class="page-header">
                    <h1 class="page-title">客變預約管理</h1>
                </div>

                <!-- 查詢條件區 -->
                <div class="search-panel">
                    <form class="search-form case-search-form" id="searchForm">
                        <div class="search-grid">
                            <!-- 案場 -->
                            <div class="form-group row">
                                <label class="form-label col-label">案場</label>
                                <div class="col-input">
                                    <select class="form-select" id="searchProject">
                                        <option value="">請選擇</option>
                                        <option value="陸府原森">陸府原森</option>
                                        <option value="陸府觀微">陸府觀微</option>
                                        <option value="陸府植森">陸府植森</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 戶別 -->
                            <div class="form-group row">
                                <label class="form-label col-label">戶別</label>
                                <div class="col-input">
                                    <input type="text" class="form-input" id="searchUnit" placeholder="請輸入戶別">
                                </div>
                            </div>
                            <!-- 會員姓名 -->
                            <div class="form-group row">
                                <label class="form-label col-label">會員姓名</label>
                                <div class="col-input">
                                    <input type="text" class="form-input" id="searchMember" placeholder="請輸入會員姓名">
                                </div>
                            </div>
                            <!-- 狀態 -->
                            <div class="form-group row">
                                <label class="form-label col-label">狀態</label>
                                <div class="col-input">
                                    <select class="form-select" id="searchStatus">
                                        <option value="">請選擇</option>
                                        <option value="待確認">待確認</option>
                                        <option value="已確認">已確認</option>
                                        <option value="已完成">已完成</option>
                                        <option value="已取消">已取消</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 繳費狀態 -->
                            <div class="form-group row">
                                <label class="form-label col-label">繳費狀態</label>
                                <div class="col-input">
                                    <select class="form-select" id="searchPaymentStatus">
                                        <option value="">請選擇</option>
                                        <option value="待繳費">待繳費</option>
                                        <option value="已繳費">已繳費</option>
                                        <option value="無需繳費">無需繳費</option>
                                        <option value="逾期未繳">逾期未繳</option>
                                    </select>
                                </div>
                            </div>
                            <!-- 預約日期 -->
                            <div class="form-group row">
                                <label class="form-label col-label">預約日期</label>
                                <div class="col-input">
                                    <div class="date-range-group">
                                        <input type="date" class="form-input" id="searchDateFrom">
                                        <span class="date-separator">~</span>
                                        <input type="date" class="form-input" id="searchDateTo">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- 操作按鈕 -->
                        <div class="form-actions-right">
                            <button type="reset" class="btn btn-info">
                                <i class="fa-solid fa-rotate-left"></i>
                                重置
                            </button>
                            <button type="submit" class="btn btn-info">
                                <i class="fa-solid fa-magnifying-glass"></i>
                                查詢
                            </button>
                            <button type="button" class="btn btn-info" id="btnExport">
                                <i class="fa-solid fa-download"></i>
                                匯出
                            </button>
                            <a href="reservation-custom-schedule.html" class="btn btn-info">
                                <i class="fa-solid fa-calendar-days"></i>
                                時段管理
                            </a>
                            <button type="button" class="btn btn-success" id="btnAdd">
                                新增預約
                            </button>
                        </div>
                    </form>
                </div>

                <!-- 資料表格 -->
                <div class="table-responsive">
                    <table class="data-table case-table" id="reservationTable">
                        <thead>
                            <tr>
                                <th class="col-1">序號</th>
                                <th class="col-1">案場</th>
                                <th class="col-1">戶別</th>
                                <th class="col-1">會員姓名</th>
                                <th class="col-1">聯絡電話</th>
                                <th class="col-2">可預約時段</th>
                                <th class="col-2">已預約日期</th>
                                <th class="col-1">出席資訊</th>
                                <th class="col-1">繳費狀態</th>
                                <th class="col-1">狀態</th>
                                <th class="col-1">操作</th>
                            </tr>
                        </thead>
                        <tbody id="reservationTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- 分頁元件 -->
                <div class="pagination-wrapper" id="paginationWrapper">
                </div>
            </div>
        </main>
    </div>

    <!-- 新增/編輯預約 頁面跳轉處理 -->
    <!-- Modal HTML removed -->

    <!-- JavaScript -->
    <script src="js/menu-component.js"></script>
    <script src="js/sidebar.js"></script>
    <script src="js/pagination.js"></script>
    <script src="js/mock-data.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 渲染側邊欄
            if (typeof renderSidebar === 'function') {
                renderSidebar();
            }

            // 渲染共用元件
            if (typeof initCRMLayout === 'function') {
                initCRMLayout();
            }
            
            // 初始化側邊欄
            const sidebarManager = new SidebarManager();
            // const reservationModal = new Modal({ id: 'reservationModal' }); // Removed
            
            // Local Mock Data for Custom Change Reservations
            // 模擬客變預約資料
            let customReservations = [
                {
                    id: 1,
                    projectName: '陸府原森',
                    unitName: 'A棟8F',
                    memberName: '王大明',
                    phone: '0912-345-678',
                    bookableStartDate: '2025-10-01',
                    bookableEndDate: '2025-10-31',
                    reservationDate: '2025-10-15',
                    timeSlot: '10:00-11:00',
                    changeType: '格局變更',
                    status: '已預約',
                    paymentStatus: '待繳費',
                    hasUnread: true,
                    attendees: 2,
                    hasDesigner: true,
                    remark: '希望與設計師討論'
                },
                {
                    id: 2,
                    projectName: '陸府原森',
                    unitName: 'B棟12F',
                    memberName: '張美玲',
                    phone: '0922-333-444',
                    bookableStartDate: '2025-10-01',
                    bookableEndDate: '2025-10-31',
                    reservationDate: '2025-10-16',
                    timeSlot: '14:00-15:00',
                    changeType: '水電配置',
                    status: '已完成',
                    paymentStatus: '已繳費',
                    hasUnread: false,
                    attendees: 1,
                    hasDesigner: false,
                    remark: ''
                },
                {
                    id: 3,
                    projectName: '陸府觀微',
                    unitName: 'C棟5F',
                    memberName: '李小華',
                    phone: '0933-555-666',
                    bookableStartDate: '2025-11-01',
                    bookableEndDate: '2025-11-30',
                    reservationDate: '2025-11-05',
                    timeSlot: '09:00-10:00',
                    changeType: '建材升級',
                    status: '已取消',
                    paymentStatus: '無需繳費',
                    hasUnread: false,
                    attendees: 3,
                    hasDesigner: true,
                    remark: '臨時有事改期'
                },
                {
                    id: 4,
                    projectName: '陸府植森',
                    unitName: '1棟-3F',
                    memberName: '陳志偉',
                    phone: '0911-222-333',
                    bookableStartDate: '2025-10-01',
                    bookableEndDate: '2025-10-31',
                    reservationDate: '',
                    timeSlot: '',
                    changeType: '',
                    status: '待確認',
                    paymentStatus: '無需繳費',
                    hasUnread: false,
                    attendees: 1,
                    hasDesigner: false,
                    remark: '尚未預約'
                }
            ];

            let currentPage = 1;
            const pageSize = 10;
            
            loadReservationData();
            
            function loadReservationData() {
                // 1. 收集篩選條件
                const searchProject = document.getElementById('searchProject').value;
                const searchUnit = document.getElementById('searchUnit').value.toLowerCase();
                const searchMember = document.getElementById('searchMember').value.toLowerCase();
                const searchStatus = document.getElementById('searchStatus').value;
                const searchPaymentStatus = document.getElementById('searchPaymentStatus').value;
                const searchDateFrom = document.getElementById('searchDateFrom').value;
                const searchDateTo = document.getElementById('searchDateTo').value;

                // 2. 取得資料
                let data = customReservations;

                // 3. 篩選資料
                data = data.filter(item => {
                    if (searchProject && item.projectName !== searchProject) return false;
                    if (searchUnit && !item.unitName.toLowerCase().includes(searchUnit)) return false;
                    if (searchMember && !item.memberName.toLowerCase().includes(searchMember)) return false;
                    if (searchStatus && item.status !== searchStatus) return false;
                    if (searchPaymentStatus && item.paymentStatus !== searchPaymentStatus) return false;
                    if (searchDateFrom && item.reservationDate < searchDateFrom) return false;
                    if (searchDateTo && item.reservationDate > searchDateTo) return false;
                    return true;
                });
                
                // 4. 排序 (依日期時間倒序)
                data.sort((a, b) => {
                    const timeA = (a.reservationDate && a.timeSlot) ? new Date(`${a.reservationDate} ${a.timeSlot.split('-')[0]}`).getTime() : 0;
                    const timeB = (b.reservationDate && b.timeSlot) ? new Date(`${b.reservationDate} ${b.timeSlot.split('-')[0]}`).getTime() : 0;
                    return timeB - timeA;
                });
                
                // Generate Serial Number
                const dateCounts = {};
                data.forEach(item => {
                    const dateStr = (item.reservationDate || '250101').replace(/-/g, '').substring(2); // YYMMDD
                    if (!dateCounts[dateStr]) {
                        dateCounts[dateStr] = 0;
                    }
                    dateCounts[dateStr]++;
                    const seq = String(dateCounts[dateStr]).padStart(2, '0');
                    item.displaySerial = `cus${dateStr}${seq}`;
                });
                
                // 5. 分頁
                const total = data.length;
                const totalPages = Math.ceil(total / pageSize);
                const start = (currentPage - 1) * pageSize;
                const pagedItems = data.slice(start, start + pageSize);

                // 6. 渲染
                renderTable(pagedItems);
                renderPagination({
                    page: currentPage,
                    totalPages: totalPages,
                    total: total
                });
            }
            
            function renderTable(data) {
                const tbody = document.getElementById('reservationTableBody');
                
                if (data.length === 0) {
                   tbody.innerHTML = '<tr><td colspan="10" class="text-center">無資料</td></tr>';
                    return;
                }
                
                tbody.innerHTML = data.map(function(item, index) {
                    let statusClass = '';
                    switch(item.status) {
                        case '待確認': statusClass = 'status-pending'; break;
                        case '已確認': statusClass = 'status-confirmed'; break;
                        case '已完成': statusClass = 'status-completed'; break;
                        case '已取消': statusClass = 'status-cancelled'; break;
                    }

                    let paymentStatusClass = '';
                    switch(item.paymentStatus) {
                        case '待繳費': paymentStatusClass = 'status-pending'; break;
                        case '已繳費': paymentStatusClass = 'status-completed'; break;
                        case '無需繳費': paymentStatusClass = 'status-cancelled'; break;
                        case '逾期未繳': paymentStatusClass = 'status-cancelled'; break;
                        default: paymentStatusClass = 'status-secondary';
                    }

                    const bookableRange = (item.bookableStartDate && item.bookableEndDate) 
                        ? `<div>${item.bookableStartDate}</div>~ ${item.bookableEndDate}</div>`
                        : '-';

                    const reservedDateTime = (item.reservationDate)
                        ? `<div>${item.reservationDate}</div>${item.timeSlot || ''}</div>`
                        : '-';

                    const unreadBadge = item.hasUnread 
                        ? '<span class="unread-badge" title="有未讀訊息"><i class="fa-solid fa-envelope"></i></span>' 
                        : '';
                    
                    const attendeesInfo = `<div>${item.attendees || 1} 人</div>` + 
                                          (item.hasDesigner ? '<div style="color: var(--color-info); font-size: 0.85em;">含設計師</div>' : '');

                    return `
                        <tr>
                            <td class="col-1" data-label="序號">${item.displaySerial || '-'}${unreadBadge}</td>
                            <td class="col-1" data-label="案場">${item.projectName}</td>
                            <td class="col-1" data-label="戶別">${item.unitName}</td>
                            <td class="col-1" data-label="會員姓名">${item.memberName}</td>
                            <td class="col-1" data-label="聯絡電話">${item.phone || '-'}</td>
                            <td class="col-2" data-label="可預約時段">${bookableRange}</td>
                            <td class="col-2" data-label="已預約日期">${reservedDateTime}</td>
                            <td class="col-1" data-label="出席資訊">${attendeesInfo}</td>
                            <td class="col-1" data-label="繳費狀態"><span class="status-badge ${paymentStatusClass}">${item.paymentStatus || '-'}</span></td>
                            <td class="col-1" data-label="狀態"><span class="status-badge ${statusClass}">${item.status}</span></td>
                            <td class="col-1" data-label="操作">
                                <div class="table-actions" style="justify-content: center;">
                                    <button type="button" class="btn-table-edit" data-id="${item.id}">編輯</button>
                                    <button type="button" class="btn-table-delete" data-id="${item.id}">刪除</button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                
                bindTableEvents();
            }
            
            function bindTableEvents() {
                 document.querySelectorAll('.btn-table-edit').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        editReservation(id);
                    });
                });
                
                document.querySelectorAll('.btn-table-delete').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        const id = parseInt(this.dataset.id);
                        deleteReservation(id);
                    });
                });
            }


            
            document.getElementById('btnAdd').addEventListener('click', function() {
                window.location.href = 'reservation-custom-edit.html';
            });
            
            function editReservation(id) {
                window.location.href = `reservation-custom-edit.html?id=${id}`;
            }
            
            function deleteReservation(id) {
                const item = customReservations.find(r => r.id === id);
                if (!item) return;
                
                ConfirmDialog.show({
                    title: '確認刪除',
                    message: `確定要刪除 ${item.memberName} 的客變預約嗎？`,
                    onConfirm: function() {
                        const index = customReservations.findIndex(r => r.id === id);
                        if (index !== -1) {
                            customReservations.splice(index, 1);
                            alert('已刪除預約');
                            loadReservationData();
                        }
                    }
                });
            }
            
            document.getElementById('btnExport').addEventListener('click', function() {
                alert('匯出功能開發中...');
            });
            
            document.getElementById('searchForm').addEventListener('submit', function(e) {
                e.preventDefault();
                currentPage = 1;
                loadReservationData();
            });
            
            document.getElementById('searchForm').addEventListener('reset', function() {
                setTimeout(function() {
                    currentPage = 1;
                    loadReservationData();
                }, 0);
            });

            function renderPagination(result) {
                const wrapper = document.getElementById('paginationWrapper');
                if (result.totalPages <= 1) {
                    wrapper.innerHTML = '';
                    return;
                }
                wrapper.innerHTML = `
                    <div class="pagination">
                        <span class="pagination-info">共 ${result.total} 筆，第 ${result.page} / ${result.totalPages} 頁</span>
                        <div class="pagination-buttons">
                            <button class="pagination-btn" ${result.page === 1 ? 'disabled' : ''} data-page="${result.page - 1}">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>
                            ${generatePageButtons(result.page, result.totalPages)}
                            <button class="pagination-btn" ${result.page === result.totalPages ? 'disabled' : ''} data-page="${result.page + 1}">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                `;
                wrapper.querySelectorAll('.pagination-btn:not([disabled])').forEach(function(btn) {
                    btn.addEventListener('click', function() {
                        currentPage = parseInt(this.dataset.page);
                        loadReservationData();
                    });
                });
            }
            
            function generatePageButtons(current, total) {
                let buttons = '';
                for (let i = 1; i <= total; i++) {
                    if (i === current) {
                        buttons += `<button class="pagination-btn active">${i}</button>`;
                    } else if (i === 1 || i === total || (i >= current - 2 && i <= current + 2)) {
                        buttons += `<button class="pagination-btn" data-page="${i}">${i}</button>`;
                    } else if (i === current - 3 || i === current + 3) {
                        buttons += '<span class="pagination-ellipsis">...</span>';
                    }
                }
                return buttons;
            }
        });
    </script>
</body>
</html>